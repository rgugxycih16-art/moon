<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上肿病理会诊 - 智能向导</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* --- 基础设置 --- */
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: #f8fafc;
            padding-top: 105px; 
        }
        @media (min-width: 768px) {
            body { padding-top: 64px; }
        }

        /* --- 导航栏样式 --- */
        .glass-nav {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .nav-item {
            position: relative;
            color: #64748b;
            font-weight: 500;
            transition: all 0.2s;
        }
        .nav-item:hover { color: #0d9488; }
        .nav-item.active { color: #0f766e; }
        
        .mobile-tabs {
            overflow-x: auto;
            scrollbar-width: none;
        }
        .mobile-tabs::-webkit-scrollbar { display: none; }

        /* --- 图表与动画 --- */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            height: 300px;
            margin: 0 auto;
        }

        /* --- 流程图节点样式 --- */
        .flow-node { 
            transition: all 0.3s ease; 
        }

        /* --- 激活路径的高亮样式 --- */
        .active-path {
            border-color: #0d9488 !important; /* teal-600 */
            background-color: #f0fdfa !important; /* teal-50 */
            box-shadow: 0 4px 6px -1px rgba(13, 148, 136, 0.1);
            transform: scale(1.02);
        }

        /* --- 情景按钮基础样式 --- */
        .scenario-btn {
            text-align: left;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 56px;
            border-width: 1px;
        }

        /* --- 按钮上的小标签样式 --- */
        .scenario-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 8px;
            white-space: nowrap;
            font-weight: bold;
        }

        /* --- 二维码核心修正样式 (关键修改) --- */
        /* 强制隐藏 Canvas，显示 Img，解决安卓/iOS长按无法识别的问题 */
        #qrcode canvas { 
            display: none !important; 
        }
        #qrcode img { 
            display: block !important; 
            margin: 0 auto; 
            max-width: 100%; 
            height: auto; 
        }
        
        /* 给二维码容器一个最小高度，防止未生成时塌陷 */
        #qrcode { 
            min-height: 200px; 
            min-width: 200px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden;
            background: #fff;
        }
    </style>
</head>
<body class="text-slate-700">

    <!-- ================= 导航栏 ================= -->
    <nav class="glass-nav fixed top-0 w-full z-50">
        <div class="max-w-4xl mx-auto">
            <div class="h-14 px-4 flex justify-between items-center">
                <!-- 左侧：Logo & Phone -->
                <div class="flex flex-col">
                    <h1 class="text-stone-800 font-bold text-base leading-none tracking-tight">上海陪诊小河</h1>
                    <div class="flex items-center gap-1 text-stone-400 text-xs mt-1.5 font-medium tracking-wide">
                        <i data-lucide="phone" class="w-3 h-3"></i>
                        <span>17898872018</span>
                    </div>
                </div>

                <!-- 右侧：电脑端菜单 -->
                <div class="flex items-center gap-4">
                    <div class="hidden md:flex gap-5 text-sm font-medium">
                        <button onclick="scrollToSection('prep')" class="nav-item">准备材料</button>
                        <button onclick="scrollToSection('logic')" class="nav-item">会诊原理</button>
                        <button onclick="scrollToSection('process')" class="nav-item">送诊流程</button>
                        <button onclick="scrollToSection('result')" class="nav-item">结果查询</button>
                        <button onclick="scrollToSection('mail')" class="nav-item">快递邮寄</button>
                    </div>

                    <!-- 触发器：右上角按钮 -->
                    <button onclick="toggleModal(true)" class="flex items-center gap-1.5 bg-amber-50 hover:bg-amber-100 text-amber-700 border border-amber-200 px-3 py-1.5 rounded-full transition-all text-xs md:text-sm font-bold shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        <span>需代办/咨询?</span>
                    </button>
                </div>
            </div>

            <!-- 下层：移动端菜单 -->
            <div class="md:hidden border-t border-slate-100 mobile-tabs">
                <div class="flex px-2 min-w-full">
                    <button onclick="scrollToSection('prep')" class="flex-none py-3 text-sm font-medium text-slate-600 px-4 border-b-2 border-transparent focus:text-teal-600 transition-colors">准备材料</button>
                    <button onclick="scrollToSection('logic')" class="flex-none py-3 text-sm font-medium text-slate-600 px-4 border-b-2 border-transparent focus:text-teal-600 transition-colors">会诊原理</button>
                    <button onclick="scrollToSection('process')" class="flex-none py-3 text-sm font-medium text-slate-600 px-4 border-b-2 border-transparent focus:text-teal-600 transition-colors">送诊流程</button>
                    <button onclick="scrollToSection('result')" class="flex-none py-3 text-sm font-medium text-slate-600 px-4 border-b-2 border-transparent focus:text-teal-600 transition-colors">结果查询</button>
                    <button onclick="scrollToSection('mail')" class="flex-none py-3 text-sm font-medium text-slate-600 px-4 border-b-2 border-transparent focus:text-teal-600 transition-colors">快递邮寄</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="max-w-4xl mx-auto px-4 mt-2">
        <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-xl border border-orange-100 p-5 md:p-6 flex items-start gap-3 shadow-sm">
            <div class="bg-orange-100 p-2.5 rounded-full shrink-0 flex items-center justify-center text-orange-600">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            </div>
            <div>
                <h1 class="text-lg md:text-xl font-bold text-orange-900 mb-1.5">病理会诊·全流程向导</h1>
                <p class="text-orange-800 text-sm md:text-base opacity-90 leading-relaxed font-medium">
                    为您梳理复旦大学附属肿瘤医院（上肿）送切片的材料准备、会诊流程与时间节点。
                </p>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8 space-y-12">

        <!-- Section 1: Preparation -->
        <section id="prep" class="bg-white rounded-xl shadow-lg p-5 md:p-8">
            <div class="mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="bg-teal-100 text-teal-800 text-xs md:text-sm px-2 py-1 rounded">第一步</span>
                    准备材料 
                </h2>
                <div class="text-sm md:text-base text-slate-600 mt-3 space-y-3">
                    <p class="leading-relaxed">
                        这是最关键的一步。请对照手中的材料，勾选下方的清单，<span class="bg-teal-50 text-teal-700 px-1 font-bold border border-teal-100 rounded">标有底色的项目</span>为重点检查对象。我们会通过图表显示您的准备完成度。
                    </p>
                    
                    <div class="bg-amber-50 border border-amber-100 rounded-md p-2.5 inline-block w-full md:w-auto">
                        <span class="font-bold text-amber-700 text-xs bg-amber-200 px-1.5 py-0.5 rounded mr-1">提示</span>
                        <span class="text-amber-800 text-sm">所有的切片和资料都需要从原手术/活检医院借出。</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div class="space-y-4">
                    <h3 class="font-semibold text-slate-700 border-b pb-2 text-sm md:text-base">核心材料</h3>
                    <div class="space-y-3" id="checklist-container"></div>
                    <h3 class="font-semibold text-slate-700 border-b pb-2 pt-4 text-sm md:text-base">可选材料</h3>
                    <div class="space-y-3" id="checklist-optional-container"></div>
                </div>

                <div class="flex flex-col items-center bg-slate-50 rounded-lg p-6">
                    <h3 class="font-semibold text-slate-700 mb-4 text-sm md:text-base">准备完成度</h3>
                    <div class="chart-container">
                        <canvas id="readinessChart"></canvas>
                    </div>
                    <div id="readiness-text" class="mt-4 text-center text-sm font-medium text-slate-500">请勾选左侧项目</div>
                    <div id="missing-alert" class="hidden mt-2 p-2 bg-red-50 text-red-600 text-xs rounded w-full text-center font-bold">
                        缺少HE切片或病理报告，无法会诊！
                    </div>
                </div>
            </div>
            
            <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="bg-purple-50 p-4 rounded border border-purple-100">
                    <div class="font-bold text-purple-800 mb-1 text-sm md:text-base">HE 切片</div>
                    <div class="text-xs text-purple-600 mb-2">通常为紫色</div>
                    <p class="text-xs md:text-sm text-slate-600">常规病理诊断，用于观察组织结构和细胞形态。标签上通常有 "HE" 字样。</p>
                </div>
                <div class="bg-amber-50 p-4 rounded border border-amber-100">
                    <div class="font-bold text-amber-800 mb-1 text-sm md:text-base">免疫组化 (IHC)</div>
                    <div class="text-xs text-amber-600 mb-2">通常为棕色</div>
                    <p class="text-xs md:text-sm text-slate-600">标签上有 ER, PR, Ki-67 等指标。用于明确分型和来源。</p>
                </div>
                <div class="bg-slate-100 p-4 rounded border border-slate-200">
                    <div class="font-bold text-slate-800 mb-1 text-sm md:text-base">白片 / 蜡块</div>
                    <div class="text-xs text-slate-500 mb-2">透明/白色</div>
                    <p class="text-xs md:text-sm text-slate-600"><b> 用于上肿加做检查，经过不同染色处理后即HE切片或免疫组化切片。收到加项通知再送过去或者提前准备</b>高质量涂胶白片（15张）或原始蜡块。</p>
                </div>
            </div>
        </section>

        <!-- Section 2: Logic Simulator -->
        <section id="logic" class="bg-white rounded-xl shadow-lg p-5 md:p-8">
            <div class="mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="bg-teal-100 text-teal-800 text-xs md:text-sm px-2 py-1 rounded">原理</span>
                    医生怎么看片子？
                </h2>
                <p class="text-sm md:text-base text-slate-500 mt-2">
                    很多家属不清楚何时需要白片/蜡块。通过下方的互动流程图，理解“白片”在病理会诊中的作用。
                </p>
            </div>

            <!-- === 情景选择按钮组 === -->
            <div class="flex flex-col gap-3 mb-8 px-1 md:px-4">
                <!-- 第一行：未带白片 / 染色片组 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <!-- 情景 A -->
                    <button onclick="setScenario('a')" id="btn-a" class="scenario-btn rounded-lg border-slate-300 hover:bg-slate-50 transition focus:outline-none bg-white">
                        <div>
                            <div class="font-bold text-sm text-slate-700 mb-0.5"><span class="bg-green-100 text-green-800 scenario-badge border border-green-200">情景 A</span>形态典型，只送染色片</div>
                            <div class="text-xs text-slate-500">最基础的情况 (简单)</div>
                        </div>
                    </button>
                    <!-- 情景 B -->
                    <button onclick="setScenario('b')" id="btn-b" class="scenario-btn rounded-lg border-slate-300 hover:bg-slate-50 transition focus:outline-none bg-white">
                        <div>
                            <div class="font-bold text-sm text-slate-700 mb-0.5"><span class="bg-blue-100 text-blue-800 scenario-badge border border-blue-200">情景 B</span>需要确诊，只送染色片</div>
                            <div class="text-xs text-slate-500">需补做免疫组化 (复杂)</div>
                        </div>
                    </button>
                </div>
                
                <!-- 第二行：自带白片组 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <!-- 情景 C -->
                    <button onclick="setScenario('c')" id="btn-c" class="scenario-btn rounded-lg border-slate-300 hover:bg-slate-50 transition focus:outline-none bg-white">
                        <div>
                            <div class="font-bold text-sm text-slate-700 mb-0.5"><span class="bg-teal-100 text-teal-800 scenario-badge border border-teal-200">情景 C</span>需要确诊, 提前准备白片(无误)</div>
                            <div class="text-xs text-slate-500">直接补费即可 (复杂)</div>
                        </div>
                    </button>
                    <!-- 情景 D -->
                    <button onclick="setScenario('d')" id="btn-d" class="scenario-btn rounded-lg border-slate-300 hover:bg-slate-50 transition focus:outline-none bg-white">
                        <div>
                            <div class="font-bold text-sm text-slate-700 mb-0.5"><span class="bg-purple-100 text-purple-800 scenario-badge border border-purple-200">情景 D</span>形态典型，提前准备白片</div>
                            <div class="text-xs text-slate-500">准备充分但未用上 (简单)</div>
                        </div>
                    </button>
                    <!-- 情景 E -->
                    <button onclick="setScenario('e')" id="btn-e" class="scenario-btn rounded-lg border-slate-300 hover:bg-slate-50 transition focus:outline-none bg-white">
                        <div>
                            <div class="font-bold text-sm text-slate-700 mb-0.5"><span class="bg-red-100 text-red-800 scenario-badge border border-red-200">情景 E</span>需要确诊, 提前准备白片(有误)</div>
                            <div class="text-xs text-slate-500">去切病理科想要的蜡块 (复杂)</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- === 交互式流程图 === -->
            <div class="relative bg-slate-50 p-4 md:p-6 rounded-xl border border-slate-200 overflow-hidden">
                <!-- 顶部节点：初审 -->
                <div class="flex justify-center mb-8">
                    <div id="node-he" class="flow-node w-64 bg-white border-2 border-slate-300 p-4 rounded shadow-sm text-center z-10">
                        <div class="font-bold text-slate-700 text-sm md:text-base">1. 初审 (HE切片)</div>
                        <div class="text-xs text-slate-500">医生在显微镜下观察形态</div>
                    </div>
                </div>
                
                <!-- 连接线 -->
                <div class="flex justify-center h-12 relative -mt-4 mb-4">
                    <div class="w-0.5 bg-slate-300 h-full"></div>
                </div>
                
                <!-- 分支结构 -->
                <div class="grid grid-cols-2 gap-4 md:gap-8 relative">
                    <!-- 左侧分支：快速通道 -->
                    <div class="flex flex-col items-center">
                        <div id="path-line-left" class="w-0.5 bg-slate-300 h-8 mb-2"></div>
                        <div id="node-report-fast" class="flow-node w-full max-w-xs bg-white border-2 border-slate-300 p-3 md:p-4 rounded shadow-sm text-center h-full flex flex-col justify-center">
                            <div class="font-bold text-slate-700 text-sm md:text-base">直接出报告</div>
                            <div class="text-xs text-slate-500 mt-1">无需额外材料</div>
                            
                            <!-- 动态结果 A -->
                            <div class="text-xs text-teal-600 font-bold mt-2 hidden scenario-text-a bg-teal-50 p-1 rounded">
                                顺利！通常7天内出结果
                            </div>
                            <!-- 动态结果 D (退回) -->
                            <div class="text-xs text-teal-600 font-bold mt-2 hidden scenario-text-d bg-teal-50 p-1 rounded">
                                顺利！通常7天内出结果<br><span class="text-amber-600">白片退回</span>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧分支：复杂通道 -->
                    <div class="flex flex-col items-center">
                        <div id="path-line-right" class="w-0.5 bg-slate-300 h-8 mb-2"></div>
                        <div id="node-advanced" class="flow-node w-full max-w-xs bg-white border-2 border-slate-300 p-3 md:p-4 rounded shadow-sm text-center relative">
                            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-amber-100 text-amber-800 text-[10px] px-2 py-0.5 rounded-full border border-amber-200">关键节点</div>
                            <div class="font-bold text-slate-700 text-sm md:text-base">需要免疫组化/分子检测</div>
                            
                            <!-- 白片消耗节点 -->
                            <div id="node-use-white" class="mt-4 pt-4 border-t border-dashed border-slate-200">
                                <div class="bg-teal-50 border border-teal-200 rounded p-2 text-sm text-teal-800 font-medium">
                                    消耗白片 / 蜡块
                                </div>
                                <div class="text-xs text-slate-400 mt-1">重新染色检测</div>
                                
                                <!-- 情景 C 提示 -->
                                <div class="text-xs text-teal-600 font-bold mt-2 hidden scenario-text-c">
                                    ✓ 白片合格，仅需补费
                                </div>
                                <!-- 情景 B & E 提示 -->
                                <div class="text-xs text-amber-600 font-bold mt-2 hidden scenario-text-b scenario-text-e">
                                    去原医院切白片，补缴费用
                                </div>
                            </div>
                        </div>
                        
                        <div class="h-6 w-0.5 bg-slate-300 mt-2"></div>
                        
                        <!-- 最终报告节点 -->
                        <div id="node-report-slow" class="flow-node w-full max-w-xs bg-white border-2 border-slate-300 p-3 md:p-4 rounded shadow-sm text-center mt-2">
                            <div class="font-bold text-slate-700 text-sm md:text-base">出具最终报告</div>
                            
                            <!-- 情景 C 耗时 -->
                            <div class="text-xs text-teal-600 font-bold mt-2 hidden scenario-text-c">耗时增加14天-30天</div>
                            
                            <!-- 情景 B & E 耗时 -->
                            <div class="text-xs text-teal-600 font-bold mt-2 hidden scenario-text-b scenario-text-e bg-green-50 p-1 rounded border border-green-100">耗时增加14天-30天</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: Process Timeline -->
        <section id="process" class="bg-white rounded-xl shadow-lg p-5 md:p-8">
            <div class="mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="bg-teal-100 text-teal-800 text-xs md:text-sm px-2 py-1 rounded">流程</span>
                    送片当天时间轴
                </h2>
                <p class="text-sm md:text-base text-slate-500 mt-2">当天如何安排？请参考以下步骤。</p>
            </div>

            <div class="space-y-6 relative border-l-2 border-slate-200 ml-3 pl-8 py-2">
                <div class="relative">
                    <div class="absolute -left-[41px] bg-teal-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shadow-md">1</div>
                    <h3 class="font-bold text-lg text-slate-800">
                        送片前一天：预约挂号
                    </h3>
                    <p class="text-sm md:text-base text-slate-600 mt-1">
                        在网上预约挂号“组织病理会诊”。
                    </p>
                </div>

                <div class="relative">
                    <div class="absolute -left-[41px] bg-teal-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shadow-md">2</div>
                    <h3 class="font-bold text-lg text-slate-800">到达医院：病理科报到</h3>
                    <p class="text-sm md:text-base text-slate-600 mt-1">无需排长队，在等候区等待叫号。</p>
                </div>

                <div class="relative">
                    <div class="absolute -left-[41px] bg-teal-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shadow-md">3</div>
                    <h3 class="font-bold text-lg text-slate-800">窗口办理：提交材料</h3>
                    <p class="text-sm md:text-base text-slate-600 mt-1">到窗口出示电子就诊卡/医保卡，提交切片和纸质资料。</p>
                    <div class="mt-2 p-3 bg-teal-50 border border-teal-100 rounded text-sm md:text-base">
                        <span class="font-bold text-teal-800">获得凭证：</span>
                        窗口会返还一张《病理会诊告知单》，即进入会诊流程。
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 4: Result Estimator -->
        <section id="result" class="bg-white rounded-xl shadow-lg p-5 md:p-8">
            <div class="mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="bg-teal-100 text-teal-800 text-xs md:text-sm px-2 py-1 rounded">查询</span>
                    结果预测计算器
                </h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-slate-50 p-4 md:p-6 rounded-lg border border-slate-200">
                    <label class="block font-bold text-slate-700 mb-2 text-sm md:text-base">您是哪天送进去的？</label>
                    <input type="date" id="submission-date" class="w-full p-2 border border-slate-300 rounded mb-6 focus:ring-2 focus:ring-teal-500 focus:outline-none text-slate-700">

                    <label class="block font-bold text-slate-700 mb-2 text-sm md:text-base">目前的状态 / 是否收到通知？</label>
                    <div class="space-y-3">
                        <label class="flex items-center space-x-3 cursor-pointer p-3 bg-white border border-slate-200 rounded-lg hover:border-teal-400 transition">
                            <input type="radio" name="redo-status" value="no" checked class="form-radio text-teal-600 focus:ring-teal-500 h-4 w-4">
                            <span class="text-sm md:text-base text-slate-700">暂无通知 / 刚送进去</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer p-3 bg-white border border-slate-200 rounded-lg hover:border-amber-400 transition">
                            <input type="radio" name="redo-status" value="ihc" class="form-radio text-amber-600 focus:ring-amber-500 h-4 w-4">
                            <div>
                                <span class="block text-sm md:text-base font-bold text-slate-700">补费通知 (免疫组化/FISH)</span>
                                <span class="block text-xs text-slate-500">通常需要加做染色</span>
                            </div>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer p-3 bg-white border border-slate-200 rounded-lg hover:border-purple-400 transition">
                            <input type="radio" name="redo-status" value="mol" class="form-radio text-purple-600 focus:ring-purple-500 h-4 w-4">
                            <div>
                                <span class="block text-sm md:text-base font-bold text-slate-700">补费通知 (基因检测/分子病理)</span>
                                <span class="block text-xs text-slate-500">测序耗时较长</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="flex flex-col justify-center">
                    <div id="result-output" class="text-center p-6 bg-teal-50 border-2 border-teal-100 rounded-lg transition-colors duration-300">
                        <div class="text-sm text-teal-600 uppercase tracking-wide font-bold mb-1">预计出结果日期</div>
                        <div id="result-date-display" class="text-3xl font-bold text-teal-800 my-2">--</div>
                        <div id="result-desc" class="text-sm text-teal-700 font-medium">请选择送诊日期</div>
                    </div>
                    <div class="mt-4 text-xs text-slate-400 text-center px-4">
                        *注：此时间为系统根据常规流程估算。若遇节假日或疑难病例，时间可能会相应顺延。
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: Packing Guide -->
        <section id="mail" class="bg-white rounded-xl shadow-lg p-5 md:p-8 border border-slate-100 relative overflow-hidden">
            <div class="absolute -right-10 -top-10 text-slate-50 opacity-50 pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-48 w-48" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
            </div>

            <div class="mb-6 relative z-10">
                <h2 class="text-xl md:text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="bg-amber-100 text-amber-800 text-xs md:text-sm px-2 py-1 rounded">推荐</span>
                    📦 切片快递包装指南
                </h2>
                <p class="text-sm md:text-base text-slate-500 mt-2">
                    切片可选择快递邮寄。
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 relative z-10">
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 hover:shadow-md transition-shadow">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">1</span>
                        <h3 class="font-bold text-slate-700">内部填充</h3>
                    </div>
                    <p class="text-sm text-slate-600 leading-relaxed">
                        用纸巾填充切片盒子内部空隙，然后用皮筋固定盒子。
                    </p>
                    <div class="mt-3 text-xs text-slate-500 bg-white p-2 rounded border border-slate-100">
                        ✅ <b>原则：</b> 摇晃盒子时，内部切片不晃动即可。
                    </div>
                </div>

                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 hover:shadow-md transition-shadow">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">2</span>
                        <h3 class="font-bold text-slate-700">防震处理</h3>
                    </div>
                    <p class="text-sm text-slate-600 leading-relaxed">
                        使用气泡膜包裹切片盒子，包裹完成后用胶带缠绕固定。
                    </p>
                    <div class="mt-3 text-xs text-slate-500 bg-white p-2 rounded border border-slate-100">
                        💡 <b>提示：</b> 可以多包几层气泡膜
                    </div>
                </div>

                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 hover:shadow-md transition-shadow">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">3</span>
                        <h3 class="font-bold text-slate-700">外部包装</h3>
                    </div>
                    <p class="text-sm text-slate-600 leading-relaxed">
                        找一个坚固的纸箱，放入包裹好的切片。告知快递小哥里面是“易碎品”。
                    </p>
                    <div class="mt-3 text-xs text-slate-500 bg-white p-2 rounded border border-slate-100">
                        📦 <b>建议：</b> 使用顺丰快递，更加稳妥。
                    </div>
                </div>
            </div>

            <div class="mt-6 bg-yellow-50 border border-yellow-100 rounded-lg p-3 flex items-start gap-3 relative z-10">
                <span class="text-xl">🌟</span>
                <div>
                    <div class="font-bold text-yellow-800 text-sm">切片保存小贴士</div>
                    <div class="text-xs md:text-sm text-yellow-700 mt-1">
                        切片和蜡块<b>常温保存</b>即可，<b>不要沾水</b>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Disclaimer Footer -->
    <footer class="text-center text-stone-400 text-xs py-8 mt-4">
        <p>注：内容仅供经验参考，具体请以医院官方规定为准。</p>
        <p class="mt-2 opacity-60">
            需要帮助? <button onclick="toggleModal(true)" class="underline hover:text-stone-600">联系小河</button>
        </p>
    </footer>

    <!-- 微信弹窗 (Modal) -->
    <div id="qrModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black bg-opacity-60 backdrop-blur-sm transition-all duration-300 opacity-0 pointer-events-none" onclick="toggleModal(false)">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full relative shadow-2xl transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
            <!-- 关闭按钮 -->
            <button onclick="toggleModal(false)" class="absolute top-3 right-4 text-gray-400 hover:text-gray-700 text-3xl font-light focus:outline-none">&times;</button>
            
            <div class="text-center mt-2">
                <h3 class="text-xl font-bold text-slate-800 mb-1">添加微信联系</h3>
                <p class="text-sm text-slate-500 mb-4">长按识别或扫一扫下方二维码</p>
                
                <!-- 二维码容器 (JS将在这里生成内容) -->
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-100 mb-4 flex justify-center items-center">
                    <div id="qrcode"></div>
                </div>
                
                <div class="font-bold text-teal-700 text-lg">上海陪诊小河</div>
                <div class="text-slate-500 text-sm flex items-center justify-center gap-1 mt-1">
                    <i data-lucide="phone" class="w-3 h-3"></i>
                    <span>17898872018</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Modal & QR Logic (修复版) ---
        // 状态标记，防止重复生成
        let qrGenerated = false;

        function toggleModal(show) {
            const modal = document.getElementById('qrModal');
            const modalContent = modal.querySelector('div'); // 获取内部的卡片div
            
            if (show) {
                // 显示弹窗
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-100', 'pointer-events-auto');
                // 内容放大动画
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
                
                // 首次打开时生成二维码
                if (!qrGenerated) {
                    generateQR();
                }
            } else {
                // 隐藏弹窗
                modal.classList.remove('opacity-100', 'pointer-events-auto');
                modal.classList.add('opacity-0', 'pointer-events-none');
                // 内容缩小动画
                modalContent.classList.remove('scale-100');
                modalContent.classList.add('scale-95');
            }
        }

        function generateQR() {
            const qrContainer = document.getElementById("qrcode");
            if (qrContainer) {
                // 清空容器，防止重复
                qrContainer.innerHTML = ""; 
                
                // 调用库生成二维码
                new QRCode(qrContainer, {
                    text: "https://u.wechat.com/EKcPjhL9GyGJtvlbGIc9Bbs",
                    width: 200, 
                    height: 200,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
                
                qrGenerated = true;

                // --- 核心修复逻辑 ---
                // QRCode.js 默认生成 canvas，但在 iOS/Android 上长按 canvas 往往无法弹出“识别二维码”。
                // 解决方案：延迟将 canvas 转为 img 标签。
                setTimeout(() => {
                    const canvas = qrContainer.querySelector('canvas');
                    const img = qrContainer.querySelector('img');
                    
                    if (canvas) {
                        const dataUrl = canvas.toDataURL("image/png");
                        let targetImg = img;
                        if (!targetImg) {
                            targetImg = document.createElement("img");
                            qrContainer.appendChild(targetImg);
                        }
                        
                        targetImg.src = dataUrl;
                        targetImg.style.display = "block";
                        canvas.style.display = "none";
                    }
                }, 100); // 延时 100ms 确保二维码绘制完成
            }
        }
        
        // --- Data ---
        const checklistItems = [
            { id: 'c1', text: 'HE染色切片 (紫色, 必需)', required: true, highlight: true },
            { id: 'c2', text: '免疫组化切片 (棕色, 如有)', required: true, highlight: true },
            { id: 'c3', text: '高质量涂胶白片15张 (3微米)或 蜡块', required: true },
            { id: 'c4', text: '原单位病理报告 (必需)', required: true, highlight: true },
        ];
        const optionalItems = [
            { id: 'o1', text: '手术记录', highlight: true },
            { id: 'o2', text: '出院小结', highlight: true },
            { id: 'o3', text: '影像检查报告 (CT/MRI)' },
            { id: 'o4', text: '内镜报告' }
        ];

        // 状态管理
        let checkedState = new Set();
        let chartInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            initChecklist();
            initChart();

            setupDateCalculator();
            document.getElementById('submission-date').valueAsDate = new Date();
            updateResultDate();
            
            // 初始化 Lucide 图标
            lucide.createIcons();

            // Scroll Spy
            window.addEventListener('scroll', highlightNav);
        });

        // --- Checklist Logic ---
        function initChecklist() {
            const reqContainer = document.getElementById('checklist-container');
            const optContainer = document.getElementById('checklist-optional-container');
            
            const createItem = (item) => {
                const div = document.createElement('div');
                let wrapperClass = "flex items-start space-x-3 p-3 rounded-lg cursor-pointer transition-all border ";
                let labelClass = "font-medium text-slate-700 cursor-pointer select-none";

                if (item.highlight) {
                    wrapperClass += "bg-teal-50 border-teal-100 hover:bg-teal-100";
                    labelClass = "font-bold text-teal-800 cursor-pointer select-none";
                } else {
                    wrapperClass += "bg-transparent border-transparent hover:bg-slate-50";
                }

                div.className = wrapperClass;
                div.onclick = (e) => toggleCheck(item.id, e);
                
                div.innerHTML = `
                    <div class="relative flex items-center pt-0.5">
                        <input type="checkbox" id="${item.id}" class="peer h-5 w-5 cursor-pointer text-teal-600 rounded border-slate-300 focus:ring-teal-500" ${checkedState.has(item.id) ? 'checked' : ''}>
                    </div>
                    <div class="text-sm leading-5 w-full">
                        <label for="${item.id}" class="${labelClass} ${item.required ? 'after:content-["*"] after:ml-0.5 after:text-red-500' : ''}">
                            ${item.text}
                        </label>
                    </div>`;
                return div;
            };
            
            checklistItems.forEach(i => reqContainer.appendChild(createItem(i)));
            optionalItems.forEach(i => optContainer.appendChild(createItem(i)));
        }

        function toggleCheck(id, event) {
            if (event.target.tagName !== 'INPUT') {
                const cb = document.getElementById(id);
                cb.checked = !cb.checked;
            }
            const cb = document.getElementById(id);
            cb.checked ? checkedState.add(id) : checkedState.delete(id);
            updateChart();
        }

        // --- Chart & Score Logic ---
        function initChart() {
            const ctx = document.getElementById('readinessChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['已准备', '未准备'],
                    datasets: [{ data: [0, 100], backgroundColor: ['#0d9488', '#e2e8f0'], borderWidth: 0 }]
                },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '75%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                },
                plugins: [{
                    id: 'textCenter',
                    beforeDraw: function(chart) {
                        const width = chart.width, height = chart.height, ctx = chart.ctx;
                        ctx.restore();
                        ctx.font = "bold " + (height/114).toFixed(2) + "em sans-serif";
                        ctx.textBaseline = "middle";
                        ctx.fillStyle = "#0f766e";
                        const text = Math.round(calculatePercentage()) + "%",
                            textX = Math.round((width - ctx.measureText(text).width) / 2),
                            textY = height / 2;
                        ctx.fillText(text, textX, textY);
                        ctx.save();
                    }
                }]
            });
        }

        function calculatePercentage() {
            let reqScore = (checklistItems.filter(i => checkedState.has(i.id)).length / checklistItems.length) * 80;
            let optScore = (optionalItems.filter(i => checkedState.has(i.id)).length / optionalItems.length) * 20;
            let total = reqScore + optScore;
            if (checkedState.has('c1') && checkedState.has('c4')) {
                total = Math.max(total, 60);
            }
            return total;
        }

        function updateChart() {
            const percent = calculatePercentage();
            chartInstance.data.datasets[0].data = [percent, 100 - percent];
            chartInstance.update();
            
            const textEl = document.getElementById('readiness-text');
            const alertEl = document.getElementById('missing-alert');
            const hasHE = checkedState.has('c1');
            const hasWhite = checkedState.has('c3');
            const hasReport = checkedState.has('c4');
            const basicMet = hasHE && hasReport;

            if (!hasHE && hasWhite && hasReport) {
                textEl.innerHTML = `
                    <div class="text-teal-700 font-bold mb-1">基本满足会诊条件</div>
                    <div class="text-xs text-slate-500 text-left bg-amber-50 p-2 rounded border border-amber-100 leading-snug">
                        1个蜡块（或对应白片15张）＋病理报告 <b>可以会诊</b>。<br>
                        <span class="text-amber-700 mt-1 block font-medium">但全部HE切片(对应所有蜡块)最为全面，医生可以看到所有取样区域的整体情况，视野最完整，也更容易判断最具代表性的病灶。</span>
                    </div>
                `;
                textEl.className = "mt-4 w-full px-1";
                alertEl.classList.add('hidden');
            } else if (basicMet) {
                if (percent === 100) {
                    textEl.innerText = "准备完美！出发吧！";
                    textEl.className = "mt-4 text-center text-sm font-bold text-teal-600";
                } else {
                    textEl.innerText = "基础材料已备齐";
                    textEl.className = "mt-4 text-center text-sm font-bold text-teal-600";
                }
                alertEl.classList.add('hidden');
            } else {
                textEl.innerText = "请核对左侧清单";
                textEl.className = "mt-4 text-center text-sm font-medium text-slate-500";
                const missingAnyRequired = checklistItems.some(i => i.required && !checkedState.has(i.id));
                if (missingAnyRequired) {
                    alertEl.classList.remove('hidden');
                } else {
                    alertEl.classList.add('hidden');
                }
            }
        }

        // --- Nav Highlight ---
        function highlightNav() {
            const sections = ['prep', 'logic', 'process', 'result', 'mail'];
            const scrollPos = window.scrollY + 120;
            let current = '';
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section.offsetTop <= scrollPos) current = id;
            });

            document.querySelectorAll('.nav-item, .mobile-tabs button').forEach(btn => {
                btn.classList.remove('active', 'text-teal-700', 'border-teal-600', 'text-teal-600');
                btn.classList.add('text-slate-600');
                if (btn.getAttribute('onclick').includes(`'${current}'`)) {
                    btn.classList.add('active', 'text-teal-700');
                    if(btn.classList.contains('border-b-2')) { 
                        btn.classList.add('border-teal-600', 'text-teal-600');
                        btn.classList.remove('text-slate-600');
                    }
                }
            });
        }

        // --- New Logic Scenario Control ---
        function setScenario(scenario) {
            // 1. 重置所有流程节点的状态
            document.querySelectorAll('.flow-node').forEach(el => { 
                el.classList.remove('active-path', 'opacity-50'); 
            });

            // 2. 重置所有按钮的样式
            document.querySelectorAll('.scenario-btn').forEach(el => { 
                el.classList.remove(
                    'bg-green-50', 'border-green-300', 'ring-green-500', 
                    'bg-blue-50', 'border-blue-300', 'ring-blue-500', 
                    'bg-teal-50', 'border-teal-300', 'ring-teal-500', 
                    'bg-purple-50', 'border-purple-300', 'ring-purple-500', 
                    'bg-red-50', 'border-red-300', 'ring-red-500', 
                    'ring-1', 'ring-2', 'bg-white'
                ); 
                el.classList.add('bg-white', 'border-slate-300'); 
            });

            // 3. 隐藏所有动态文本
            document.querySelectorAll(
                '.scenario-text-a, .scenario-text-b, .scenario-text-c, .scenario-text-d, .scenario-text-e'
            ).forEach(el => el.classList.add('hidden'));

            // 4. 设置当前按钮样式
            const btn = document.getElementById('btn-' + scenario);
            btn.classList.remove('bg-white', 'border-slate-300'); 
            
            if(scenario === 'a') btn.classList.add('bg-green-50', 'border-green-300', 'ring-1', 'ring-green-500');
            if(scenario === 'b') btn.classList.add('bg-blue-50', 'border-blue-300', 'ring-1', 'ring-blue-500');
            if(scenario === 'c') btn.classList.add('bg-teal-50', 'border-teal-300', 'ring-1', 'ring-teal-500');
            if(scenario === 'd') btn.classList.add('bg-purple-50', 'border-purple-300', 'ring-1', 'ring-purple-500');
            if(scenario === 'e') btn.classList.add('bg-red-50', 'border-red-300', 'ring-1', 'ring-red-500');

            // 5. 获取节点
            const nodes = {
                he: document.getElementById('node-he'),
                fast: document.getElementById('node-report-fast'),
                adv: document.getElementById('node-advanced'),
                white: document.getElementById('node-use-white'),
                slow: document.getElementById('node-report-slow')
            };

            nodes.he.classList.add('active-path');
            
            // 6. 激活路径
            if (scenario === 'a') {
                nodes.fast.classList.add('active-path');
                document.querySelectorAll('.scenario-text-a').forEach(el => el.classList.remove('hidden'));
                nodes.adv.classList.add('opacity-50'); 
                nodes.slow.classList.add('opacity-50');
            } 
            else if (scenario === 'd') {
                nodes.fast.classList.add('active-path');
                document.querySelectorAll('.scenario-text-d').forEach(el => el.classList.remove('hidden'));
                nodes.adv.classList.add('opacity-50'); 
                nodes.slow.classList.add('opacity-50');
            } 
            else if (scenario === 'c') {
                nodes.adv.classList.add('active-path'); 
                nodes.slow.classList.add('active-path');
                document.querySelectorAll('.scenario-text-c').forEach(el => el.classList.remove('hidden'));
                nodes.fast.classList.add('opacity-50');
            } 
            else if (scenario === 'b' || scenario === 'e') {
                nodes.adv.classList.add('active-path'); 
                nodes.slow.classList.add('active-path');
                document.querySelectorAll('.scenario-text-b').forEach(el => el.classList.remove('hidden')); 
                
                nodes.fast.classList.add('opacity-50');
                nodes.white.classList.add('animate-pulse');
                setTimeout(() => nodes.white.classList.remove('animate-pulse'), 2000);
            }

            // 7. 平滑滚动
            const nodeHe = document.getElementById('node-he');
            const headerOffset = 180;
            const elementPosition = nodeHe.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

            window.scrollTo({
                top: offsetPosition,
                behavior: "smooth"
            });
        }

        // --- Date Calculator ---
        function setupDateCalculator() {
            document.getElementById('submission-date').addEventListener('change', updateResultDate);
            document.querySelectorAll('input[name="redo-status"]').forEach(r => r.addEventListener('change', updateResultDate));
        }

        function updateResultDate() {
            const dateInput = document.getElementById('submission-date').value;
            if (!dateInput) return;
            
            const subDate = new Date(dateInput);
            const status = document.querySelector('input[name="redo-status"]:checked').value;
            
            const displayEl = document.getElementById('result-date-display');
            const descEl = document.getElementById('result-desc');
            const outputBox = document.getElementById('result-output');
            const formatDate = (d) => `${d.getMonth() + 1}月${d.getDate()}日`;
            
            let targetDate = new Date(subDate);

            outputBox.className = "text-center p-6 border-2 rounded-lg transition-colors duration-300";
            displayEl.className = "text-3xl font-bold my-2";

            if (status === 'no') {
                targetDate.setDate(subDate.getDate() + 7);
                outputBox.classList.add('bg-teal-50', 'border-teal-100');
                displayEl.classList.add('text-teal-800');
                descEl.className = "text-sm text-teal-700 font-medium";
                displayEl.innerText = formatDate(targetDate) + " 前";
                descEl.innerText = "如果一切顺利，通常在此日期前出结果";
            } else if (status === 'ihc') {
                targetDate.setDate(subDate.getDate() + 14);
                outputBox.classList.add('bg-amber-50', 'border-amber-100');
                displayEl.classList.add('text-amber-800');
                descEl.className = "text-sm text-amber-700 font-medium";
                displayEl.innerText = formatDate(targetDate) + " 左右";
                descEl.innerText = "免疫组化/FISH 检测周期约为两周";
            } else if (status === 'mol') {
                targetDate.setDate(subDate.getDate() + 30);
                outputBox.classList.add('bg-purple-50', 'border-purple-100');
                displayEl.classList.add('text-purple-800');
                descEl.className = "text-sm text-purple-700 font-medium";
                displayEl.innerText = formatDate(targetDate) + " 左右";
                descEl.innerText = "分子/基因检测步骤复杂，耗时约一个月";
            }
        }

        function scrollToSection(id) {
            const element = document.getElementById(id);
            const headerOffset = 110; 
            const elementPosition = element.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
            window.scrollTo({ top: offsetPosition, behavior: "smooth" });
        }
    </script>
</body>
</html>